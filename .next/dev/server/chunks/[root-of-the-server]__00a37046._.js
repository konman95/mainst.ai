module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/process [external] (process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}),
"[externals]/tls [external] (tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/net [external] (net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/http2 [external] (http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http2", () => require("http2"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/dns [external] (dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/lib/firebaseServer.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "db",
    ()=>db
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$firebase$2f$app$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/firebase/app/dist/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$app$2f$dist$2f$esm$2f$index$2e$esm$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@firebase/app/dist/esm/index.esm.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$firebase$2f$firestore$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/firebase/firestore/dist/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@firebase/firestore/dist/index.node.mjs [app-route] (ecmascript)");
;
;
const firebaseConfig = {
    apiKey: ("TURBOPACK compile-time value", "AIzaSyBLoFQJatOZYvCiimNqF84cXtg2YpOxp3Y"),
    authDomain: ("TURBOPACK compile-time value", "main-st-ai.firebaseapp.com"),
    databaseURL: ("TURBOPACK compile-time value", "https://main-st-ai-default-rtdb.firebaseio.com"),
    projectId: ("TURBOPACK compile-time value", "main-st-ai"),
    storageBucket: ("TURBOPACK compile-time value", "main-st-ai.firebasestorage.app"),
    messagingSenderId: ("TURBOPACK compile-time value", "816395647058"),
    appId: ("TURBOPACK compile-time value", "1:816395647058:web:06a5bcedae2e11cfdb078b"),
    measurementId: ("TURBOPACK compile-time value", "G-WCZN8L5HSK")
};
const app = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$app$2f$dist$2f$esm$2f$index$2e$esm$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getApps"])().length ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$app$2f$dist$2f$esm$2f$index$2e$esm$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getApp"])() : (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$app$2f$dist$2f$esm$2f$index$2e$esm$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["initializeApp"])(firebaseConfig);
const db = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getFirestore"])(app);
}),
"[project]/lib/firebaseAuth.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "resolveUid",
    ()=>resolveUid
]);
async function lookupUid(token, apiKey) {
    const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${apiKey}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            idToken: token
        })
    });
    if (!res.ok) return null;
    const data = await res.json();
    return data?.users?.[0]?.localId || null;
}
async function resolveUid(authHeader) {
    if (!authHeader?.startsWith("Bearer ")) return {
        uid: null
    };
    const token = authHeader.slice(7);
    if (token.startsWith("dev-")) {
        return {
            uid: "dev"
        };
    }
    const apiKey = ("TURBOPACK compile-time value", "AIzaSyBLoFQJatOZYvCiimNqF84cXtg2YpOxp3Y");
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    const uid = await lookupUid(token, apiKey);
    return {
        uid
    };
}
}),
"[project]/lib/devStore.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "addAction",
    ()=>addAction,
    "addAudit",
    ()=>addAudit,
    "addContact",
    ()=>addContact,
    "addMessage",
    ()=>addMessage,
    "getConversation",
    ()=>getConversation,
    "getOwnerCoverSettings",
    ()=>getOwnerCoverSettings,
    "getProfile",
    ()=>getProfile,
    "listActions",
    ()=>listActions,
    "listAudit",
    ()=>listAudit,
    "listContacts",
    ()=>listContacts,
    "listMessages",
    ()=>listMessages,
    "removeContact",
    ()=>removeContact,
    "setOwnerCoverSettings",
    ()=>setOwnerCoverSettings,
    "setProfile",
    ()=>setProfile,
    "updateAction",
    ()=>updateAction,
    "updateContact",
    ()=>updateContact
]);
const devProfile = {
    name: "Main St AI",
    services: "Lead response, scheduling, and front-desk coverage",
    hours: "Mon–Fri, 9am–6pm",
    serviceArea: "Local service area",
    pricingNotes: "Pricing varies by service tier; ask clarifying questions.",
    policies: "No legal or refund decisions without owner approval.",
    tone: "Calm, professional, concise.",
    updatedAt: Date.now()
};
let contacts = [];
let conversations = [];
let actions = [];
let audit = [];
let ownerCoverSettings = {
    mode: "monitor",
    confidenceThreshold: 0.85,
    restrictedTopics: [
        "billing",
        "complaints",
        "legal"
    ],
    quietHoursStart: "20:00",
    quietHoursEnd: "07:00",
    quietHoursEnabled: false
};
function makeId() {
    return `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
}
function getProfile() {
    return devProfile;
}
function setProfile(next) {
    Object.assign(devProfile, next, {
        updatedAt: Date.now()
    });
    return devProfile;
}
function listContacts() {
    return contacts;
}
function addContact(input) {
    const now = Date.now();
    const contact = {
        id: makeId(),
        name: String(input.name || ""),
        email: String(input.email || ""),
        phone: String(input.phone || ""),
        notes: String(input.notes || ""),
        tags: Array.isArray(input.tags) ? input.tags : [],
        status: String(input.status || "new"),
        lastContact: null,
        createdAt: now,
        updatedAt: now
    };
    contacts.unshift(contact);
    return contact;
}
function updateContact(id, input) {
    const idx = contacts.findIndex((c)=>c.id === id);
    if (idx === -1) return null;
    contacts[idx] = {
        ...contacts[idx],
        ...input,
        updatedAt: Date.now()
    };
    return contacts[idx];
}
function removeContact(id) {
    const before = contacts.length;
    contacts = contacts.filter((c)=>c.id !== id);
    return contacts.length < before;
}
function getConversation(id) {
    let convo = conversations.find((c)=>c.id === id);
    if (!convo) {
        convo = {
            id,
            uid: "dev",
            messages: [],
            updatedAt: Date.now()
        };
        conversations.push(convo);
    }
    return convo;
}
function addMessage(conversationId, role, content) {
    const convo = getConversation(conversationId);
    const message = {
        role,
        content,
        createdAt: Date.now()
    };
    convo.messages.push(message);
    convo.updatedAt = Date.now();
    return message;
}
function listMessages(conversationId) {
    return getConversation(conversationId).messages;
}
function addAction(entry) {
    const action = {
        id: makeId(),
        uid: "dev",
        status: entry.status || "queued",
        action: entry.action,
        confidence: entry.confidence,
        restricted: entry.restricted,
        response: entry.response,
        reason: entry.reason,
        message: entry.message,
        createdAt: Date.now()
    };
    actions.unshift(action);
    return action;
}
function listActions() {
    return actions;
}
function updateAction(id, status) {
    const idx = actions.findIndex((a)=>a.id === id);
    if (idx === -1) return null;
    actions[idx] = {
        ...actions[idx],
        status
    };
    return actions[idx];
}
function addAudit(event) {
    const entry = {
        ...event,
        id: makeId(),
        createdAt: Date.now()
    };
    audit.unshift(entry);
    return entry;
}
function listAudit() {
    return audit;
}
function getOwnerCoverSettings() {
    return ownerCoverSettings;
}
function setOwnerCoverSettings(next) {
    ownerCoverSettings = {
        ...ownerCoverSettings,
        ...next
    };
    return ownerCoverSettings;
}
}),
"[project]/app/api/chat/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$firebase$2f$firestore$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/firebase/firestore/dist/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@firebase/firestore/dist/index.node.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseServer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/firebaseServer.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseAuth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/firebaseAuth.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/devStore.ts [app-route] (ecmascript)");
;
;
;
;
;
function buildPrompt(params) {
    const profile = params.profile || {};
    const lines = [
        "You are Main St AI, a calm, professional front-desk assistant for a small business.",
        "You respond clearly, avoid hype, and keep answers concise and helpful.",
        "If the user asks about pricing, ask a clarifying question instead of inventing numbers.",
        "Never claim actions you did not take.",
        "",
        `Business name: ${profile.name || "Main St AI client"}`,
        `Services: ${profile.services || "Not provided"}`,
        `Hours: ${profile.hours || "Not provided"}`,
        `Service area: ${profile.serviceArea || "Not provided"}`,
        `Pricing notes: ${profile.pricingNotes || "Not provided"}`,
        `Policies: ${profile.policies || "Not provided"}`,
        `Tone guidance: ${profile.tone || "Calm, professional, concise."}`
    ];
    if (params.contact) {
        lines.push("", `Contact name: ${params.contact.name || "Unknown"}`, `Contact email: ${params.contact.email || "Unknown"}`, `Contact phone: ${params.contact.phone || "Unknown"}`, `Contact notes: ${params.contact.notes || "None"}`, `Lead status: ${params.contact.status || "Unknown"}`);
    }
    if (params.history && params.history.length) {
        lines.push("", "Conversation history:");
        params.history.forEach((entry)=>{
            lines.push(`${entry.role.toUpperCase()}: ${entry.content}`);
        });
    }
    lines.push("", `Customer message: ${params.message}`, "Assistant response:");
    return lines.join("\n");
}
async function POST(request) {
    const { uid } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseAuth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["resolveUid"])(request.headers.get("authorization"));
    if (!uid) return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
        error: "Unauthorized"
    }, {
        status: 401
    });
    const body = await request.json().catch(()=>({}));
    const message = String(body?.message || "").trim();
    const conversationId = String(body?.conversationId || `${uid}-default`);
    if (!message) {
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Message is required."
        }, {
            status: 400
        });
    }
    const profile = uid === "dev" ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getProfile"])() : await (async ()=>{
        const ref = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["doc"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseServer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"], "businessProfiles", uid);
        const snap = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDoc"])(ref);
        if (!snap.exists()) {
            await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["setDoc"])(ref, {
                name: "Main St AI client",
                services: "",
                hours: "",
                serviceArea: "",
                pricingNotes: "",
                policies: "",
                tone: "Calm, professional, concise.",
                updatedAt: Date.now()
            });
            return {
                name: "Main St AI client",
                services: "",
                hours: "",
                serviceArea: "",
                pricingNotes: "",
                policies: "",
                tone: "Calm, professional, concise."
            };
        }
        return snap.data();
    })();
    const history = uid === "dev" ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["listMessages"])(conversationId).slice(-6).map((m)=>({
            role: m.role,
            content: m.content
        })) : await (async ()=>{
        const convoRef = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["doc"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseServer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"], "conversations", conversationId);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["setDoc"])(convoRef, {
            uid,
            updatedAt: Date.now(),
            channel: "web"
        }, {
            merge: true
        });
        const messagesRef = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["collection"])(convoRef, "messages");
        const q = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["query"])(messagesRef, (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["orderBy"])("createdAt", "desc"), (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["limit"])(6));
        const snap = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDocs"])(q);
        return snap.docs.map((docSnap)=>({
                role: docSnap.data().role,
                content: docSnap.data().content,
                createdAt: docSnap.data().createdAt
            })).sort((a, b)=>a.createdAt - b.createdAt);
    })();
    const token = process.env.HF_TOKEN;
    const model = process.env.HF_MODEL || "mistralai/Mistral-7B-Instruct-v0.2";
    if (!token) {
        const fallback = "Thanks for reaching out. How can I help you today?";
        if (uid === "dev") {
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addMessage"])(conversationId, "user", message);
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addMessage"])(conversationId, "assistant", fallback);
            (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addAudit"])({
                uid,
                type: "chat",
                message,
                response: fallback,
                decision: "sent"
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            reply: fallback,
            model: "mock",
            warning: "HF_TOKEN is not configured."
        });
    }
    const prompt = buildPrompt({
        message,
        profile,
        history
    });
    const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
        method: "POST",
        headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            inputs: prompt,
            parameters: {
                max_new_tokens: 180,
                temperature: 0.3,
                return_full_text: false
            }
        })
    });
    if (!response.ok) {
        const errorText = await response.text().catch(()=>"Hugging Face error");
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: errorText
        }, {
            status: 502
        });
    }
    const data = await response.json();
    const reply = Array.isArray(data) && data[0]?.generated_text ? String(data[0].generated_text).trim() : typeof data?.generated_text === "string" ? data.generated_text.trim() : "";
    const finalReply = reply || "Thanks for reaching out. How can I help you today?";
    if (uid === "dev") {
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addMessage"])(conversationId, "user", message);
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addMessage"])(conversationId, "assistant", finalReply);
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$devStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addAudit"])({
            uid,
            type: "chat",
            message,
            response: finalReply,
            decision: "sent"
        });
    } else {
        const convoRef = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["doc"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseServer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"], "conversations", conversationId);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["setDoc"])(convoRef, {
            uid,
            updatedAt: Date.now(),
            channel: "web"
        }, {
            merge: true
        });
        const messagesRef = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["collection"])(convoRef, "messages");
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDoc"])(messagesRef, {
            role: "user",
            content: message,
            createdAt: Date.now()
        });
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDoc"])(messagesRef, {
            role: "assistant",
            content: finalReply,
            createdAt: Date.now()
        });
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDoc"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$firebase$2f$firestore$2f$dist$2f$index$2e$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["collection"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$firebaseServer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"], "auditEvents"), {
            uid,
            type: "chat",
            message,
            response: finalReply,
            decision: "sent",
            createdAt: Date.now()
        });
    }
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
        reply: finalReply,
        model,
        conversationId
    });
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__00a37046._.js.map